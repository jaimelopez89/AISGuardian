apiVersion: v1
kind: Deployment
metadata:
  name: ais-guardian
  namespace: default  # Change to your Ververica namespace
spec:
  state: RUNNING
  deploymentTargetName: vvp-team  # Your Ververica deployment target
  template:
    spec:
      artifact:
        kind: JAR
        jarUri: "ververica-artifact://namespaces/default/artifacts/ais-guardian-ververica.jar:1"
        entryClass: com.aiswatchdog.AISWatchdogJob
        mainArgs: ""
      parallelism: 2
      numberOfTaskManagers: 1
      resources:
        jobmanager:
          cpu: 0.5
          memory: 1g
        taskmanager:
          cpu: 1
          memory: 2g
      flinkVersion: "1.18"
      flinkImageTag: "1.18.1-java11"
      flinkConfiguration:
        # Checkpointing
        execution.checkpointing.interval: "60s"
        execution.checkpointing.mode: EXACTLY_ONCE
        state.backend: rocksdb
        state.checkpoints.dir: "s3://your-bucket/checkpoints/ais-guardian"

        # Kafka Connection (Aiven) - These should reference secrets
        # The actual values will be injected via environment variables
        kafka.bootstrap.servers: "${KAFKA_BOOTSTRAP_SERVERS}"
        kafka.security.protocol: SSL

      # Environment variables - map to Ververica secrets
      env:
        - name: KAFKA_BOOTSTRAP_SERVERS
          valueFrom:
            secretKeyRef:
              name: aiven-kafka-credentials
              key: bootstrap-servers
        - name: KAFKA_SSL_TRUSTSTORE_LOCATION
          value: /opt/flink/secrets/truststore.jks
        - name: KAFKA_SSL_TRUSTSTORE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aiven-kafka-credentials
              key: truststore-password
        - name: KAFKA_SSL_KEYSTORE_LOCATION
          value: /opt/flink/secrets/keystore.p12
        - name: KAFKA_SSL_KEYSTORE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aiven-kafka-credentials
              key: keystore-password
        # Detection thresholds (optional overrides)
        - name: DARK_THRESHOLD_MINUTES
          value: "10"
        - name: RENDEZVOUS_DISTANCE_METERS
          value: "1000"
        - name: RENDEZVOUS_DURATION_MINUTES
          value: "5"

      # Mount SSL certificates from secrets
      volumes:
        - name: kafka-ssl-certs
          secret:
            secretName: aiven-kafka-ssl-certs
      volumeMounts:
        - name: kafka-ssl-certs
          mountPath: /opt/flink/secrets
          readOnly: true

      logging:
        log4jLoggers:
          "com.aiswatchdog": DEBUG
          "org.apache.flink": INFO
          "org.apache.kafka": WARN
